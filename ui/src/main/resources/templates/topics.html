<!--
 * Copyright 2020 EPAM Systems
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 -->
<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="templates :: header(~{},~{},~{})">
</head>
<body>

    <script type="text/javascript" th:inline="javascript">
        /*<![CDATA[*/
        var pageCurrent = [[${(page != null)?(page.number + 1):(0)}]];
        var totalPagesCurrent = [[${(page != null)?(page.totalPages):(0)}]];
        /*]]>*/

        var dataTable;

        $(function() {
            $('#search_form').submit(function(e) {
                e.preventDefault();
                showWaitingSign("Fetch data...");
                location.params(
                        {
                            topicName: $('#topicName').val(),
                            minPartitionCount: $('#minPartitionCount').val(),
                            maxPartitionCount: $('#maxPartitionCount').val(),
                            minReplicationFactor: $('#minReplicationFactor').val(),
                            maxReplicationFactor: $('#maxReplicationFactor').val(),
                            minConsumerCount: $('#minConsumerCount').val(),
                            maxConsumerCount: $('#maxConsumerCount').val(),
                            replicationState: $('#replicationState').val(),
                            configString: $('#configString').val(),
                            description: $('#description').val(),
                            page: 1
                        }, 
                        {}, 
                        {});
            });
            $('#pagination').twbsPagination({
                startPage: pageCurrent,
                totalPages: totalPagesCurrent,
                visiblePages: 11,
                initiateStartPageClick: false,
                first:'&lt;&lt;',
                prev:'&lt;',
                next:'&gt;',
                last:'&gt;&gt;',
                onPageClick: function (e, pageClicked) {
                    e.preventDefault();
                    location.params({page: pageClicked}, {}, {});
                }
            });
            var sortingOrderTopicName = [0, 'asc'];
            dataTable = $('#topics-table').DataTable({
                paging: false,
                info: false,
                scrollY: "40vh",
                scrollCollapse: true,
                order: [sortingOrderTopicName],
                language: {
                    searchPlaceholder: "Enter this page search expression"
                }
            });

            var toggleFullScreen = ( mode ) => {
                if(mode==='maximize') {
                    $('#recordTableContainer').addClass("full-screen");
                    $('.dataTables_scrollBody').css("min-height","80vh");
                    $('#topics-table').css("min-height","80vh");
                    $('#full-screen-button').text("Exit full screen");
                    dataTable.columns.adjust();
                    $('#fullScreen').val(true);
                } else {
                    $('#recordTableContainer').removeClass("full-screen");
                    $('#topics-table').css("min-height","45vh");
                    $('.dataTables_scrollBody').css("min-height","45vh");
                    $('#full-screen-button').text("Full screen");
                    dataTable.columns.adjust();
                    $('#fullScreen').val(false);
                }
            }

            $("#topics-table").on('init.dt', function () {
                $("#recordTableContainer").addClass("d-flex");
                dataTable.columns.adjust();
            });

            $('#full-screen-button').click(function (e) {
                if($('#recordTableContainer')[0].classList.contains("full-screen")) {
                    toggleFullScreen('minimize');
                } else {
                    toggleFullScreen('maximize');
                }
            });

            hideWaitingSign();
        });
    </script>

    <div th:replace="templates :: navbar"></div>

    <div th:replace="templates :: loading-modal"></div>

    <div class="main-content">

        <div class="container-fluid">

            <div class="row">
                <div class="col-md-12">
                    <h3>Topics (<span th:text="${totalCount}"></span>)</h3>
                </div>
            </div>
        
            <div class="row">

                <div class="col-md-12">

                    <div class="card mb-3">
                        <div class="card-body">
                        
                            <a 
                                th:href="@{/topic_create}" 
                                class="btn btn-primary">
                                Create <i class="fa fa-plus"></i>
                            </a>
                        
                            <div class="dropdown" style="display:inline-block;">
                                <button
                                    class="btn btn-primary dropdown-toggle"
                                    type="button" 
                                    id="exportButton"
                                    data-bs-toggle="dropdown"
                                    aria-haspopup="true"
                                    aria-expanded="true">
                                    Export
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="exportButton">
                                    <li>
                                        <a class="dropdown-item"
                                            th:href="@{/topics_export(exporterType=PLAIN, topicName=${searchCriteria.topicName}, minPartitionCount=${searchCriteria.minPartitionCount}, maxPartitionCount=${searchCriteria.maxPartitionCount}, minReplicationFactor=${searchCriteria.minReplicationFactor}, maxReplicationFactor=${searchCriteria.maxReplicationFactor}, minConsumerCount=${searchCriteria.minConsumerCount}, maxConsumerCount=${searchCriteria.maxConsumerCount}, replicationState=${searchCriteria.replicationState}, configString=${searchCriteria.configString}, description=${searchCriteria.description})}" target="_blank">
                                            Plain
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item"
                                            th:href="@{/topics_export(exporterType=JSON, topicName=${searchCriteria.topicName}, minPartitionCount=${searchCriteria.minPartitionCount}, maxPartitionCount=${searchCriteria.maxPartitionCount}, minReplicationFactor=${searchCriteria.minReplicationFactor}, maxReplicationFactor=${searchCriteria.maxReplicationFactor}, minConsumerCount=${searchCriteria.minConsumerCount}, maxConsumerCount=${searchCriteria.maxConsumerCount}, replicationState=${searchCriteria.replicationState}, configString=${searchCriteria.configString}, description=${searchCriteria.description})}" target="_blank">
                                            Json
                                        </a>
                                    </li>
                                </ul>
                            </div>

                        </div>
                    </div>            
                
                    <form class="form-inline form-flex flex-wrap" id="search_form">
                        <input
                            type="text"
                            class="form-control col-auto"
                            id="topicName" 
                            placeholder="Topic Name"
                            th:value="${searchCriteria.topicName}"/>
                        <input
                            type="number"
                            class="form-control col-auto"
                            min="1"
                            id="minPartitionCount" 
                            placeholder="Min Partition Count"
                            th:value="${searchCriteria.minPartitionCount}"/>
                        <input 
                            type="number"
                            class="form-control col-auto"
                            min="1"
                            id="maxPartitionCount" 
                            placeholder="Max Partition Count"
                            th:value="${searchCriteria.maxPartitionCount}"/>
                        <input 
                            type="number"
                            class="form-control col-auto"
                            min="1"
                            id="minReplicationFactor" 
                            placeholder="Min Replication Factor"
                            th:value="${searchCriteria.minReplicationFactor}"/>
                        <input 
                            type="number"
                            class="form-control col-auto"
                            min="1"
                            id="maxReplicationFactor" 
                            placeholder="Max Replication Factor"
                            th:value="${searchCriteria.maxReplicationFactor}"/>
                        <input 
                            type="number"
                            class="form-control col-auto"
                            min="1"
                            id="minConsumerCount" 
                            placeholder="Min Consumer Count"
                            th:value="${searchCriteria.minConsumerCount}"/>
                        <input 
                            type="number"
                            class="form-control col-auto"
                            min="1"
                            id="maxConsumerCount" 
                            placeholder="Max Consumer Count"
                            th:value="${searchCriteria.maxConsumerCount}"/>
                        <select title="Replication State" class="form-select col-auto" id="replicationState">
                            <option 
                                th:each="state : ${T(com.epam.eco.kafkamanager.TopicSearchCriteria$ReplicationState).values()}"
                                th:value="${state}" 
                                th:text="${state}"
                                th:selected="${state == searchCriteria.replicationState}">
                            </option>
                        </select>
                        <input
                            type="text"
                            class="form-control col-auto"
                            id="configString" 
                            placeholder="Config: Value;..."
                            th:value="${searchCriteria.configString}"/>
                        <input
                            type="text"
                            class="form-control col-auto"
                            id="description" 
                            placeholder="Description"
                            th:value="${searchCriteria.description}"/>
                        <button
                            type="submit"
                            class="btn btn-primary">
                            Find
                        </button>
                        <input id="fullScreen" name="fullScreen" th:value="${fullScreen}" type="hidden" value="false" />
                    </form>
                
                </div>
            
            </div>
            
            <div class="row">

                <div class="col-md-12">

                    <div id="recordTableContainer" th:if="${page != null}" style="background: white;">
                        <div class="d-flex">
                            <h6>Topics</h6>
                            <button id="full-screen-button" class="btn btn-secondary btn-sm to-right">Full screen</button>
                        </div>
                        <table id="topics-table" class="table table-bordered table-striped table-hover">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Partitions</td>
                                    <td>Replicas</td>
                                    <td>Config</td>
                                    <td>Consumer Groups</td>
                                    <td>Description</td>
                                    <td>Topic data</td>
                                    <td th:if="${dataCatalogUrlResolver.showColumn()}" th:text="${dataCatalogUrlResolver.toolName}"></td>
                                    <td th:if="${grafanaMetricsUrlResolver.showColumn()}" th:text="${grafanaMetricsUrlResolver.toolName}"></td>
                                    <td th:each="tool: ${externalTools}"
                                        th:if="${externalTools!=null && externalTools.size()>0}"
                                        th:text="${tool.getName()}">
                                    </td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr
                                    th:each="topic : ${page.content}"
                                    th:classappend="${topic.hasUnderReplicatedPartitions()} ? 'warning' : ''">
                                    <td>
                                        <a th:href="@{/topics/{name}(name=${topic.name})}">
                                            <span th:text="${topic.name}"></span>
                                        </a>
                                    </td>
                                    <td th:text="${topic.partitionCount}"></td>
                                    <td th:text="${topic.replicationFactor}"></td>
                                    <td
                                        th:text="${topic.configOverridesAsString}"
                                        style="white-space:pre-wrap;"></td>
                                    <td>
                                        <th:block th:each="group : ${topic.getConsumerGroupNamesAsCollapsedCol(5)}">
                                            <a th:if="${!group.divider}" th:href="@{/consumer_groups/{name}(name=${group.value})}">
                                                <span th:text="${group.value}" style="float:left;clear:left;"></span>
                                            </a>
                                            <span th:if="${group.divider}" th:text="..." style="float:left;clear:left;"></span>
                                        </th:block>
                                    </td>
                                    <td
                                        th:text="${topic.metadataDescription}"
                                        style="word-wrap:break-word;max-width:150px">
                                    </td>
                                    <td style="text-align: center;width:50px;">
                                        <a th:href="@{/topics/{name}/browser(name=${topic.name})}">
                                            <i class="fa fa-search info" aria-hidden="true"></i>
                                        </a>
                                    </td>
                                    <td th:if="${dataCatalogUrlResolver.showColumn()}" style="text-align: center;width:50px;">
                                        <a th:href="@{|${dataCatalogUrlResolver.resolve(topic.name)}|}" target="_blank">
                                            <i th:class="${'fa '+dataCatalogUrlResolver.getIcon()+' info'}" aria-hidden="true"></i>
                                        </a>
                                    </td>
                                    <td th:if="${grafanaMetricsUrlResolver.showColumn()}" style="text-align: center;width:50px;">
                                        <a th:href="@{|${grafanaMetricsUrlResolver.resolve(topic.name)}|}" target="_blank">
                                            <i th:class="${'fa '+grafanaMetricsUrlResolver.getIcon()+' info'}" aria-hidden="true"></i>
                                        </a>
                                     </td>
                                     <td th:each="tool: ${externalTools}"
                                         th:if="${externalTools!=null && externalTools.size()>0}"
                                         style="text-align: center;width:50px;">
                                         <a th:href="@{|${tool.resolve(topic.name)}|}" target="_blank">
                                            <i th:class="${'fa '+tool.getIcon()+' info'}" aria-hidden="true"></i>
                                         </a>
                                     </td>
                                </tr>
                            </tbody>
                        </table>

                        <div
                            th:if="${page.numberOfElements > 0}"
                            th:text="${'Showing ' + (page.number * page.size + 1) + ' to ' + (page.number * page.size + page.numberOfElements) + ' of ' + page.totalElements}">
                        </div>
                        
                        <ul id="pagination" class="pagination pagination-sm"></ul>
        
                    </div>
        
                </div>
        
            </div>
        
        </div>

    </div>

    <div th:replace="templates :: footer"></div>
    
</body>
</html>
