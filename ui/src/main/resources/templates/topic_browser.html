<!--
 * Copyright 2020 EPAM Systems
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); you may not
 * use this file except in compliance with the License.  You may obtain a copy
 * of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 -->
<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="templates :: header(~{::/html/head/link},~{::/html/head/script},~{})">

    <link rel="stylesheet" type="text/css" th:href="@{/components/browse-filter/browse-filter.css}" />

    <script type="text/javascript" th:src="@{/components/browse-filter/browse-filter.js}"></script>
    <script type="text/javascript" th:src="@{/js/ui_lib_browser.js}"></script>
</head>
<body>

<script type="text/javascript" th:inline="javascript">

    /*<![CDATA[*/

    const currentOffsets = [[${currentOffsets}]];
    const realRangeBounds = [[${realRangeBounds}]];
    const fetchedValueFormat = [[${browseParams.getValueFormat() != null ? browseParams.getValueFormat().name() : null}]];
    const fullScreen = [[${browseParams.getFullScreen()}]];
    const showGrid = [[${showGrid}]]

    const filterColumns = [[${columnsList}]]
    const filterClauses = [[${browseParams.getFilterClauses()}]]
    const filterOperations = [[${filterOperations}]]

    const enableAnimation = [[${enableAnimation}]]
    const topicName = [[${browseParams.topicName}]]

    /*]]>*/

    const excludes = [
        {columnName: 'default', operations: ['equals','contains','startWith','like','notEmpty']},
        {columnName: 'tombstones', operations: ['include','exclude','only']},
    ];

    if(filterColumns!==null) {
        setFilterColumnsArray(topicName, filterColumns);
    }
    if(excludes && excludes!=null) {
        setExcludes(excludes);
    }
    if(filterClauses!==null) {
        setFilterClauseArray(filterClauses);
    }
    if(filterOperations!==null) {
        setFilterOperationArray(filterOperations);
    }

    let partitionCheckboxes;

    $(document).ready(function () {

        partitionCheckboxes = $('.partition-checkbox');

        if(enableAnimation) {
            partitionCheckboxes.each(function (idx, elem) {
                const partition = $(elem).data('partition');
                $('#p_min_' + partition).addClass("inactive-partition");
                $('#p_max_' + partition).addClass("inactive-partition");
            });
        }

        const sortingOrderPartition = [0, 'asc'];
        const sortingOrderOffset = [1, 'asc'];

        const columnClasses = showGrid ?
               [ { className: "vertical-line-class", targets: "_all" },
                 { className: "vertical-line-class-selected", targets: [ 1, 3, 4 ] } ] :
               [ { className: "vertical-line-class-selected", targets: [ 1, 3, 4 ] } ];

        const dataTableItem = $('#recordTable');
        const dataTable = dataTableItem.DataTable({
            paging: false,
            processing: true,
            info: false,
            scrollX: true,
            scrollY: "40vh",
            scrollCollapse: true,
            fixedColumns: {
                left: 5
            },
            initComplete: function(settings, json) {
                setTimeout( api => api.columns.adjust(), 1000, this.api());
            },
            columnDefs: columnClasses,
            order: [
                sortingOrderPartition,
                sortingOrderOffset
            ],
            fixedHeader: true,
            language: {
                searchPlaceholder: "Enter this page search expression",
                processing: "<span class='fa-stack fa-lg'>\n\
                                 <i class='fa fa-spinner fa-spin fa-stack-2x fa-fw'></i>\n\
                             </span>&emsp;Processing ..."

            }
        });


        $('#filter-faq-button').click(() => {
            showFaq("Browser filter FAQ", "/kafka-manager/faq/topic-browser/browse-filter-faq.html");
        });
        $('#offsets-faq-button').click(() => {
            showFaq("Offsets FAQ", "/kafka-manager/faq/topic-browser/offsets-faq.html");
        });
        $('#timestamp-fetch-faq-button').click(() => {
            showFaq("Timestamp fetch FAQ", "/kafka-manager/faq/topic-browser/timestamp-fetch-faq.html");
        });
        $('#fetch-faq-button').click(() => {
            showFaq("Fetch FAQ", "/kafka-manager/faq/topic-browser/fetch-faq.html");
        });
        $('#timeout-faq-button').click(() => {
            showFaq("Timeout FAQ", "/kafka-manager/faq/topic-browser/timeout-faq.html");
        });
        $('#limit-faq-button').click(() => {
            showFaq("Limit FAQ", "/kafka-manager/faq/topic-browser/limit-faq.html");
        });

        const allPartitionCheckbox = $('#all-partition-checkbox');
        allPartitionCheckbox.click(function () {
            partitionCheckboxes.each(function (idx, elem) {
                const checked = allPartitionCheckbox.prop('checked');
                $(elem).prop('checked', checked);
                $(elem).trigger('change');
            });
        });

        partitionCheckboxes.change(function () {
            const partition = $(this).data('partition');
            const enabled = $(this).is(':checked');
            $('#pe_' + partition).val(enabled ? '1' : '0');
            $('#p_min_' + partition).prop('disabled', !enabled);
            $('#p_max_' + partition).prop('disabled', !enabled);
        });


        partitionCheckboxes.each(function (idx, elem) {
            if ($(elem).is(':checked')) {
                const partition = $(elem).data('partition');
                if(currentOffsets !== null) {
                    const currentOffset = currentOffsets[partition];
                    if (currentOffset !== undefined) {
                        const minOffsetElem = $('#p_min_' + partition);
                        if(minOffsetElem.val()!==currentOffset.smallest) {
                            minOffsetElem.val(currentOffset.smallest);
                            if(enableAnimation) blink(minOffsetElem);
                            $('#p_min_p_inc_' + partition).html(getMinBoundsLabel(currentOffset));
                            $('#p_min_inc_' + partition).val(currentOffset.smallestInclusive);
                        }
                        const maxOffsetElem = $('#p_max_' + partition);
                        if(maxOffsetElem.val()!==currentOffset.largest) {
                            maxOffsetElem.val(currentOffset.largest);
                            if(enableAnimation) blink(maxOffsetElem);
                            $('#p_max_p_inc_' + partition).html(getMaxBoundsLabel(currentOffset));
                            $('#p_max_inc_' + partition).val(currentOffset.largestInclusive);
                        }
                    }
                }
                if(realRangeBounds !== null) {
                    const realBounds = realRangeBounds[partition];
                    if (realBounds !== undefined) {
                        $('#p_min_range_' + partition).val(realBounds.smallest);
                        $('p_min_range_label_' + partition).html(realBounds.smallest + getMinBoundsLabel(realBounds));
                        $('#p_min_p_inc_' + partition).html(getMinBoundsLabel(realBounds));
                        $('#p_min_inc_' + partition).val(realBounds.smallestInclusive);
                        $('#p_max_range_' + partition).val(realBounds.largest);
                    }
                }
            }
        })

        $('.previous-offsets-link').click(function (e) {
            e.preventDefault();
            submitFetchForm("FETCH_BACKWARD", "Fetching data backward...");
        });

        $('.next-offsets-link').click(function (e) {
            e.preventDefault();
            submitFetchForm("FETCH_FORWARD", "Fetching data forward...");
        });

        $("#fetchButton").click(function (e) {
            e.preventDefault();
            submitFetchForm("FETCH_RANGE", "Fetching data by range...");
        })

        $('#all-columns-link').click(function (e) {
            e.preventDefault();
            $('.column-checkbox').each(function (idx, elem) {
                $(elem).prop('checked', true);
                $(elem).trigger('change');
            });
        });

        $('#none-columns-link').click(function (e) {
            e.preventDefault();
            $('.column-checkbox').each(function (idx, elem) {
                $(elem).prop('checked', false);
                $(elem).trigger('change');
            });
        });

        $("#offsets-timestamp").datetimepicker({
            format:'dd/mm/yyyy hh:ii:ss',
            autoclose: true

        });

        $('#search-offsets-for-time-link').click(function (e) {
            e.preventDefault();
            const stringValue = $('#offsets-timestamp').val();
            const date = moment(stringValue, 'DD/MM/YYYY HH:mm:ss', true);
            if (date && date.isValid()) {
                document.getElementById('timestamp').value = date.parseZone(0).unix() * 1000;
                submitFetchForm("FETCH_UNTIL_TIME", "Fetching records by timestamp...");
            }
            if(!date.isValid()) {
                showInfo("error","Error while fetching data", "Wrong date format! (" + stringValue + ")");
            }
        });

        $('#search-offsets-for-time-link-fwd').click(function (e) {
            e.preventDefault();
            const stringValue = $('#offsets-timestamp').val();
            const date = moment(stringValue, 'DD/MM/YYYY HH:mm:ss', true);
            if (date && date.isValid()) {
                document.getElementById('timestamp').value = date.parseZone(0).unix() * 1000;
                submitFetchForm("FETCH_FROM_TIME", "Fetching records by timestamp...");
            }
            if(!date.isValid()) {
                showInfo("error","Error while fetching data", "Wrong date format! (" + stringValue + ")");
            }
        });

        $('#keyFormat').change(function (e) {
            $('#keyFormatLabel').html('Key format: <div class="text-danger d-inline"><b>' + e.currentTarget.value + '</b></div>');
        });

        $('#valueFormat').change(function (e) {
            $('#valueFormatLabel').html('Value format: <div class="text-danger d-inline"><b>' + e.currentTarget.value + '</b></div>');
            showHideColumnSelectorDependingOnFormatSelected(fetchedValueFormat);
        });

        var submitFetchForm = (fetchMode, waitingText) => {
            if(!validateRanges()) {
                return;
            }
            if(checkIfAtLeastOnePartitionSelected()) {
                removeColumnSelectorIfFormatNotEqualToFecthedOne(fetchedValueFormat);
                storeOrApplySelectedColumns();
                $('#fetch-mode').val(fetchMode);
                $('#filter-clause').val(JSON.stringify(filterClauseArray));
                showWaitingSign(waitingText);
                $('#fetch-form').submit();
            } else {
                showInfo("error","Error while fetching data", "At least one partition have to be checked!");
            }
        }

        $('[data-bs-toggle="popover"]').popover({html: true,});

        let checkIfAtLeastOnePartitionSelected = () => {
            let result = false;
            partitionCheckboxes.each((idx, elem) => {
                if(elem.checked) {
                    result = true;
                }
            });
            return result;
        }

        let toggleFullScreen = ( mode ) => {
            if(mode==='maximize') {
                $('#recordTableContainer').addClass("full-screen");
                $('.dataTables_scrollBody').css("min-height","80vh");
                $('#full-screen-button').text("Exit full screen");
                $('#previous-offsets-link-in-grid').css("display",  "block");
                $('#next-offsets-link-in-grid').css("display", "block");
                dataTable.columns.adjust();
                $('#full-screen').val(true);
            } else {
                $('#recordTableContainer').removeClass("full-screen");
                $('.dataTables_scrollBody').css("min-height","45vh");
                $('#full-screen-button').text("Full screen");
                $('#previous-offsets-link-in-grid').css("display",  "none");
                $('#next-offsets-link-in-grid').css("display", "none");
                dataTable.columns.adjust();
                $('#full-screen').val(false);
            }
        }

        $('#full-screen-button').click(function () {
            if($('#recordTableContainer')[0].classList.contains("full-screen")) {
                toggleFullScreen('minimize');
            } else {
                toggleFullScreen('maximize');
            }
        });

        $(document).on('click', function (event) {
            hidePopoverIfClickedOutside(event);
        });

        $('#to-min-button').click( function(event) {
            event.preventDefault();
            setBeginOffsetsToMin();
        });
        $('#to-max-button').click( function(event) {
            event.preventDefault();
            setEndOffsetsToMax();
        });

        if(fullScreen) {
            toggleFullScreen('maximize');
        }

        const customParameters = $('#customParameters');
        if(isBrowserFilterSet()) {
            customParameters.text('Yes')
            customParameters.removeClass('text-primary');
            customParameters.addClass('text-danger');
        } else {
            customParameters.text('No');
            customParameters.removeClass('text-danger');
            customParameters.addClass('text-primary');
        }

        $('#tombstone-generate-button').click(()=>generateTombstone());

    })

    function getMinBoundsLabel(offsetRange) {
        return offsetRange.smallestInclusive ? '[' : '(';
    }
    function getMaxBoundsLabel(offsetRange) {
        return offsetRange.largestInclusive ? ']' : ')';
    }

    function copySchemaContent(id) {
        const text = $('#schema_content_'+id).text();
        const button = document.getElementById('copy_button_'+id);
        copyText(text,button);
    }

    function validateRanges() {
        let result = true;
        partitionCheckboxes.each(function (idx, elem) {
            if ($(elem).is(':checked')) {
                const partition = $(elem).data('partition');
                const smallest = parseInt($('#p_min_' + partition).val());
                const largest = parseInt($('#p_max_' + partition).val());
                if(largest<smallest) {
                    showInfo('error', 'Error while checking range offsets',
                        'Partition='+partition+': largest='+largest+' less then smallest='+smallest+'.');
                    result = false;
                }
            }
        });
        return result;

    }

    function openTombstoneModal(recordId, recordKey) {
        const headers = $('#headers-for_'+recordId).val();
        $.post("/kafka-manager/topics/"+topicName+"/browser/headers",
            {"headers": headers,
             "method_": "POST",
             [[${_csrf.parameterName}]]: [[${_csrf.token}]]})
            .done(function(data) {
                $("#tombstone-key-display").text(recordKey);
                $("#tombstone-key").val(recordKey);
                $("#tombstone-header-content").val(data);
                $('#tombstone-modal-dialog').modal("show");
            })
            .fail(function(xhr) {
                alert(xhr.responseText);
            })

    }

    function closeTombstoneModal() {
        const resultItem = $('#tombstone-generation-result');
        resultItem.removeClass("text-danger");
        resultItem.text('');
        $('#tombstone-modal-dialog').modal("hide");
    }

    function generateTombstone() {
        const recordKey = $('#tombstone-key').val();
        if(!recordKey) {
            resultItem.addClass("text-danger");
            resultItem.text("Key doesn't defined!");
            return;
        }
        const headers = $('#tombstone-header-content').val();
        const resultItem = $('#tombstone-generation-result');
        $.post("/kafka-manager/topics/"+topicName+"/browser/tombstone",
            {"recordKey": recordKey,
              "keyFormat": [[${browseParams.getKeyFormat()}]],
             "headers": headers,
             "method_": "POST",
             [[${_csrf.parameterName}]]: [[${_csrf.token}]]})
             .done(function(data) {
                 closeTombstoneModal();
                 showInfo('info','Tombstone generator',data);

             })
             .fail(function(xhr) {
                     resultItem.addClass("text-danger");
                     resultItem.text(xhr.responseText);
             })
    }



</script>

<div th:replace="templates :: navbar"></div>
<div th:replace="templates :: loading-modal"></div>
<div th:replace="templates :: info-modal"></div>
<div th:replace="templates :: data-modal"></div>
<div th:replace="templates :: faq-modal"></div>
<div th:replace="templates :: confirm-modal"></div>
<div th:replace="templates :: tombstone-modal"></div>

<div class="main-content">

    <div class="container-fluid">

        <div class="row">

            <div class="col-md-12">

                <div>
                    <a class="text-primary" th:href="@{/topics/{name}(name=${browseParams.topicName})}">
                        <i class="fa fa-chevron-left text-primary"></i> Back To Topic
                    </a>
                    <div class="topic-title mt-1 mb-1" th:utext="'<b>BROWSE DATA:</b> ' + ${browseParams.topicName}" ></div>
                </div>

                <div class="card mb-3">

                    <form
                            id="fetch-form"
                            th:action="@{/topics/{name}/browser(name=${browseParams.topicName})}"
                            method="post">

                        <input id="fetch-mode" name="fetch-mode" type="hidden" value="FETCH_RANGE" />
                        <input id="full-screen" name="full-screen" th:value="${browseParams.getFullScreen()}" type="hidden" value="false" />
                        <input id="timestamp" name="timestamp" type="hidden" value="0"/>
                        <input id="filter-clause" name="filter-clause" type="hidden" value="" />
                        <input id="topicName" name="topicName" th:value="${browseParams.topicName}" type="hidden" />
                        <div class="card-header card-flex">
                            <div class="col">
                                <a data-bs-toggle="collapse" href="#fetch-params"
                                   role="button"
                                   class="text-secondary collapse-button-chevron"
                                   id="topic_browser.fetch-params-button">
                                    <i class="fa fa-chevron-down"></i>
                                </a>
                                <b class="m-1">Fetch parameters:</b>
                            </div>
                            <div class="col" th:utext="${'Partitions: <div class=''text-primary d-inline''><b>' + browseParams.listPartitions().size() + '</b></div>'}"> </div>
                            <div class="col"><div th:utext="${'From offset: <b><div class=''text-primary d-inline''>' + (offsetFetchedRangesSummary == null ? '-' : offsetFetchedRangesSummary.smallest) + '</div>/' + offsetRangesSummary.smallest + '</b>'}"></div></div>
                            <div class="col"><div th:utext="${'To offset: <b><div class=''text-primary d-inline''>' + (offsetFetchedRangesSummary == null ? '-' : offsetFetchedRangesSummary.largest) + '</div>/' + offsetRangesSummary.largest + '</b>'}"></div></div>
                            <div class="col"
                                 th:utext="${'Key format: <div class=''text-primary d-inline''><b>' + browseParams.getKeyFormat() + '</b></div>'}"
                                 id="keyFormatLabel">
                            </div>
                            <div class="col" th:utext="${'Value format: <div class=''text-primary d-inline''><b>' + browseParams.getValueFormat() + '</b></div>'}"
                                 id="valueFormatLabel">
                            </div>
                            <div class="col">Custom parameters: <div class='text-primary d-inline'><b><div id="customParameters" class="d-inline"></div></b></div></div>
                        </div>
                        <div class="card-body" id="fetch-params">

                            <div class="row mb-3">
                                <div class="form-group col col-md-4">
                                    <label for="keyFormat">Key Format</label>
                                    <select class="form-select" name="keyFormat" id="keyFormat">
                                        <option
                                                th:each="format : ${T(com.epam.eco.kafkamanager.TopicRecordFetchParams$DataFormat).values()}"
                                                th:value="${format}"
                                                th:text="${format}"
                                                th:selected="${browseParams.getKeyFormat() == format}">
                                        </option>
                                    </select>
                                    <label for="valueFormat">Value Format</label>
                                    <select class="form-select mb-4" name="valueFormat" id="valueFormat">
                                        <option
                                                th:each="format : ${T(com.epam.eco.kafkamanager.TopicRecordFetchParams$DataFormat).values()}"
                                                th:value="${format}"
                                                th:text="${format}"
                                                th:selected="${browseParams.getValueFormat() == format}">
                                        </option>
                                    </select>

                                    <div id="browse-filter-block">
                                        <div
                                                th:if="${browseParams.isAvroOrProtobufValueFormat()}"
                                                th:replace="templates :: browse-filter">
                                        </div>
                                    </div>

                                </div>

                                <div class="col-md-8">
                                    <div id="offsets-parameters">
                                        <div class="container-fluid" style="padding:0">
                                            <div class="row" style="margin-right: 1em;">
                                                <div class="input-group offsets-timestamp-wrapper">
                                                    <div class="timestamp-faq-item">
                                                        <div id="timestamp-fetch-faq-button" class="faq-button"></div>
                                                    </div>
                                                    <input id="offsets-timestamp"
                                                           type="text"
                                                           name="offsetsTimestamp"
                                                           autocomplete="off"
                                                           placeholder="Enter timestamp"
                                                           th:value="${browseParams.offsetsTimestamp}"
                                                           class="form-control input-timestamp col-auto"
                                                           title="Search offsets for time"/>
                                                    <button id="search-offsets-for-time-link"
                                                            href="#"
                                                            class="btn btn-primary col-auto btn-sm btn-time-search"
                                                            title="Search offsets for time backward">
                                                        <i class="fa fa-chevron-left" aria-hidden="true"></i>
                                                    </button>
                                                    <button id="search-offsets-for-time-link-fwd"
                                                            href="#"
                                                            class="btn btn-primary col-auto btn-sm btn-time-search"
                                                            title="Search offsets for time forward">
                                                        <i class="fa fa-chevron-right" aria-hidden="true"></i>
                                                    </button>

                                                </div>

                                            </div>

                                            <div class="mb-3">
                                                <div><b>Offsets parameters</b>&nbsp;<div id="offsets-faq-button" class="faq-button"></div></div>
                                                <div class="row">

                                                    <div class="form-group mb-1">
                                                        <div class="input-group">
                                                            <span class="input-group-text col-md-2"
                                                                  th:text="'Partition'"></span>
                                                            <div class="input-group-text col-auto">
                                                                <input type="checkbox"
                                                                       id="all-partition-checkbox"
                                                                       class="form-check-input mt-0"
                                                                       th:attr="data-partition=${partition}"
                                                                       th:checked="true"/>
                                                            </div>
                                                            <span class="input-group-text col-md-2">
                                                                MIN
                                                            </span>
                                                            <span class="input-group-text form-control to-min-max-title">
                                                                <div>FIRST BATCH</div>
                                                                <button id="to-min-button"
                                                                        class="btn btn-success btn-sm btn-small to-min-max-button">
                                                                    to MIN
                                                                </button>
                                                            </span>
                                                            <span class="input-group-text form-control to-min-max-title">
                                                                <div>LAST BATCH</div>
                                                                <button id="to-max-button"
                                                                        class="btn btn-success btn-sm btn-small to-min-max-button">
                                                                    to MAX
                                                                </button>
                                                            </span>
                                                            <span class="input-group-text col-md-2">
                                                                MAX
                                                            </span>
                                                        </div>
                                                    </div>

                                                    <th:block
                                                            th:each="partition : ${browseParams.listPartitions()}"
                                                            th:with="enabled=${browseParams.isPartitionEnabled(partition)},
                                                                     offset=${browseParams.getPartitionOffset(partition)},
                                                                     range=${offsetRanges.get(partition)}">
                                                        <div class="form-group mb-1">
                                                            <div class="input-group">
                                                               <span class="input-group-text col-md-2"
                                                                     th:text="${partition}"></span>
                                                                <div class="input-group-text col-auto">
                                                                    <input type="checkbox"
                                                                           class="partition-checkbox form-check-input mt-0"
                                                                           th:attr="data-partition=${partition}"
                                                                           th:checked="${enabled}"/>
                                                                </div>
                                                                <input type="hidden"
                                                                       th:id="${'p_min_range_' + partition}"
                                                                       th:name="${'p_min_range_' + partition}"
                                                                       th:value="${range.smallest}"/>
                                                                <span class="input-group-text col-md-2"
                                                                      th:id="${'p_min_range_label_' + partition}"
                                                                      th:text="${(range.smallestInclusive ? '[' : '(') + range.smallest}"></span>
                                                                <span class="input-group-text col-auto"
                                                                      th:id="${'p_min_inc_p_' + partition}"
                                                                      th:name="${'p_min_inc_p_' + partition}"
                                                                      th:text="${(offset.smallestInclusive ? '[' : '(')}"></span>
                                                                <input type="hidden"
                                                                       th:id="${'p_min_inc_' + partition}"
                                                                       th:name="${'p_min_inc_' + partition}"
                                                                       th:value="${offset.smallestInclusive}">
                                                                <input type="number"
                                                                       class="form-control"
                                                                       th:min="${range.smallest}"
                                                                       th:max="${range.largest}"
                                                                       th:disabled="${!enabled}"
                                                                       th:id="${'p_min_' + partition}"
                                                                       th:name="${'p_min_' + partition}"
                                                                       th:value="${offset.smallest}"/>
                                                                <input type="number"
                                                                       class="form-control"
                                                                       th:min="${range.smallest}"
                                                                       th:max="${range.largest}"
                                                                       th:disabled="${!enabled}"
                                                                       th:id="${'p_max_' + partition}"
                                                                       th:name="${'p_max_' + partition}"
                                                                       th:value="${offset.largest}"/>
                                                                <span class="input-group-text col-auto"
                                                                      th:id="${'p_max_inc_p_' + partition}"
                                                                      th:name="${'p_max_inc_p_' + partition}"
                                                                      th:text="${(offset.largestInclusive ? ']' : ')')}"></span>
                                                                <input type="hidden"
                                                                       th:id="${'p_max_inc_' + partition}"
                                                                       th:name="${'p_max_inc_' + partition}"
                                                                       th:value="${offset.largestInclusive}">
                                                                <span class="input-group-text col-md-2"
                                                                      th:id="${'p_max_range_label_' + partition}"
                                                                      th:text="${range.largest + (range.largestInclusive ? ']' : ')')}"></span>
                                                                <input type="hidden"
                                                                       th:id="${'p_max_range_' + partition}"
                                                                       th:name="${'p_max_range_' + partition}"
                                                                       th:value="${range.largest}"/>
                                                                <input type="hidden"
                                                                       th:id="${'pe_' + partition}"
                                                                       th:name="${'pe_' + partition}"
                                                                       th:value="${enabled ? '1' : '0'}"/>
                                                            </div>
                                                        </div>
                                                    </th:block>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>



                            </div>

                        </div>
                        <div class="card-footer card-flex">
                            <div class="col-auto">
                                <a
                                    th:if="${hasPreviousOffsets != null AND hasPreviousOffsets}"
                                    id="previous-offsets-link"
                                    href="#"
                                    class="btn btn-success btn-sm previous-offsets-link">
                                    <i class="fa fa-chevron-left"></i>
                                </a>
                                <a id="fetchButton" class="btn btn-success btn-sm" role="button">
                                   Fetch
                                </a>
                                <a
                                    th:if="${hasNextOffsets != null AND hasNextOffsets}"
                                    id="next-offsets-link"
                                    href="#"
                                    class="btn btn-success btn-sm next-offsets-link">
                                    <i class="fa fa-chevron-right"></i>
                                </a>
                                <div class="fetch-faq-button">
                                    <div id="fetch-faq-button" class="faq-button"></div>
                                </div>
                            </div>


                            <label class="centred to-right col-auto" for="timeout">Polling record timeout (MS)</label>
                            <div id="timeout-faq-button" class="faq-button timeout-faq-button"></div>
                            <input
                                type="number"
                                class="form-control col-auto"
                                min="-1"
                                max="300000"
                                id="timeout"
                                name="timeout"
                                th:value="${browseParams.timeout}"/>


                            <label class="centred col-auto" for="limit">Limit</label>
                            <div id="limit-faq-button" class="faq-button timeout-faq-button"></div>
                            <input type="number"
                                   class="form-control col-auto"
                                   min="10"
                                   max="100"
                                   id="limit"
                                   name="limit"
                                   th:value="${browseParams.limit}"/>

                        </div>

                        <div th:if="${fetchedRecords!=null}" id="column-selector-dialog" class="modal fade" role="dialog">
                            <div class="modal-dialog column-selector-dialog">
                                <div class="modal-content column-selector-dialog-content">
                                    <div class="modal-header">
                                        <h4 class="modal-title">Columns selector</h4>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal">&times;</button>
                                    </div>
                                    <div class="modal-body" style="overflow: scroll">

                                        <div class="column-selector-dialog-column">

                                            <div class="checkbox column-selector-dialog-item"
                                                 th:each="column : ${fetchedRecords.listTopicColumns()}">
                                                <label
                                                        th:class="${!column.present ? 'text-muted' : ''}"
                                                        style="word-wrap:break-word;">
                                                    <input
                                                            class="column-checkbox"
                                                            type="checkbox"
                                                            th:name="${'ce_' + column.name}"
                                                            th:attr="data-column=${column.name}"
                                                            th:checked="${browseParams.isColumnEnabled(column.name)}"/>
                                                    <span th:text="${column.name}"></span>
                                                </label>
                                            </div>

                                        </div>

                                    </div>
                                    <div class="modal-footer">
                                        <h5>SELECT:</h5>
                                        <a id="all-columns-link"
                                           href="#"
                                           class="btn btn-primary btn-sm small ms-2">
                                            All <i class="fa fa-check-circle-o"></i>
                                        </a>
                                        <a id="none-columns-link"
                                           href="#"
                                           class="btn btn-primary btn-sm small ms-1">
                                            None <i class="fa fa-times-circle-o"></i>
                                        </a>
                                        <button type="button"
                                                class="btn btn-success ms-4"
                                                data-bs-dismiss="modal">
                                            Exit
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </form>
                </div>

                <div id="recordTableContainer" class="card" th:if="${fetchedRecords != null}">
                    <div class="card-header card-flex">

                            <a
                                    th:if="${hasPreviousOffsets != null AND hasPreviousOffsets}"
                                    id="previous-offsets-link-in-grid"
                                    href="#"
                                    style="display: none"
                                    class="btn btn-success btn-sm previous-offsets-link">
                                <i class="fa fa-chevron-left"></i>
                            </a>
                            <a
                                    th:if="${hasNextOffsets != null AND hasNextOffsets}"
                                    id="next-offsets-link-in-grid"
                                    href="#"
                                    style="display: none"
                                    class="btn btn-success btn-sm next-offsets-link">
                                <i class="fa fa-chevron-right"></i>
                            </a>
                        <h7><span th:text="${fetchSummary}"></span></h7>
                        <button id="column-filter-button"
                                class="btn btn-primary btn-sm to-right"
                                type="button"
                                data-bs-target="#column-selector-dialog"
                                data-bs-toggle="modal" >
                            <i class="fa fa-check-square-o"></i>Columns selector
                        </button>

                        <button id="full-screen-button" class="btn btn-secondary btn-sm">Full screen</button>
                    </div>
                    <div class="pre-scrollable"
                         style="padding-top: 0;">

                        <table id="recordTable"
                               aria-sort="descending"
                               th:if="${!fetchedRecords.isEmpty()}"
                               class="table cell-border">
                            <thead>
                            <tr>
                                <th>Partition</th>
                                <th>Offset</th>
                                <th>Timestamp (UTC)</th>
                                <th>Key</th>
                                <th>Key/Value size</th>
                                <th>Headers</th>
                                <th th:if="${browseParams.isAvroOrProtobufValueFormat()}">Attributes
                                </th>
                                <th th:if="${browseParams.isAvroOrProtobufValueFormat() and schemaCatalogUrlTemplate!=null}">Schema
                                </th>
                                <th th:each="column : ${fetchedRecords.listSelectedColumns()}">
                                        <span th:text="${column.name}"
                                              th:class="${!column.present ? 'text-muted' : ''}">
                                        </span>
                                </th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="record : ${fetchedRecords}"
                                th:with="recordId=${record.partition + '_' + record.offset} ">
                                <td th:text="${record.partition}"></td>
                                <td th:text="${record.offset}"></td>
                                <td th:text="${record.timestampFormatted}"></td>
                                <td
                                        th:if="${record.nullKey}"
                                        class="danger"
                                        title="Record Key is NULL">
                                </td>
                                <td th:if="${!record.nullKey}"
                                    style="min-width:10em;max-width:21.5em;">

                                    <div class="d-flex" style="justify-content: space-between">
                                        <div class="tombstone-column" th:text="${record.key}"></div>
                                        <a class="btn btn-sm info tombstone-icon-column"
                                           th:if="${writeAllowed}"
                                           type="button"
                                           th:data-record-id="${recordId}"
                                           th:data-record-key="${record.key}"
                                           th:onclick="openTombstoneModal(this.getAttribute('data-record-id'),this.getAttribute('data-record-key'))"
                                           style="padding-left: 0.3em" >
                                            <img th:src="@{/assets/img/tombstone.png}" th:title="${'Generate tombstone for key='+record.key}" />
                                        </a>
                                    </div>

                                </td>
                                <td th:text="${record.keyValueSizeFormatted}"></td>
                                <td style="text-align: center;vertical-align: middle;">
                                    <a style="vertical-align: middle"
                                       th:if="${record.hasHeaders()}"
                                       href="javascript:void(0)"
                                       th:attr="data-bs-container='body',
                                                data-bs-toggle='popover',
                                                data-bs-content=${record.headersPrettyJson},
                                                title='Headers',
                                                data-bs-html=true"
                                       data-bs-toggle="popover"
                                       data-html="true">
                                        <i class="fa fa-eye info"></i>
                                    </a>
                                </td>

                                <td th:if="${browseParams.isAvroOrProtobufValueFormat()}"
                                    style="text-align: center;vertical-align: middle;">
                                    <a style="vertical-align: middle"
                                       th:if="${record.hasAttributes()}"
                                       href="javascript:void(0);"
                                       data-bs-toggle="popover"
                                       data-bs-backdrop=""
                                       th:attr="data-bs-container='body',
                                                data-bs-content=${record.attributesPrettyJson},
                                                title='Attributes',
                                                data-bs-html=true">
                                        <i class="fa fa-list info"></i>
                                    </a>
                                </td>

                                <td th:if="${record.hasAttributes() and schemaCatalogUrlTemplate!=null}"
                                    style="text-align:center;vertical-align:middle;">

                                    <a th:if="${record.hasAttributes()}"
                                       class="btn btn-sm info"
                                       type="button"
                                       th:attr="data-bs-target=${'#schema-modal-dialog-'+recordId},data-bs-html=true"
                                       data-bs-toggle='modal'
                                       data-bs-backdrop>
                                        <i class="fa fa-file-code-o info"></i>
                                    </a>

                                    <div th:id="${'schema-modal-dialog-'+recordId}"
                                         th:if="${record.hasAttributes()}"
                                         class="modal fade"
                                         role="dialog">
                                        <div class="modal-dialog schema-content-dialog">
                                            <div class="modal-content" style="max-height:90vh">
                                                <div class="modal-header">
                                                    <h4 class="modal-title"
                                                        th:text="${browseParams.getValueFormat() + ' SCHEMA (ID=' + record.RegistrySchema.schemaId + ') FOR MESSAGE WITH KEY=&quot;' + record.key + '&quot;' }">
                                                    </h4>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal">&times;</button>
                                                </div>
                                                <div class="modal-body schema-content-dialog-body">
                                                    <pre th:id="${'schema_content_'+recordId}" th:text="${record.RegistrySchema.schemaAsString}"></pre>
                                                </div>
                                                <div class="modal-footer">
                                                    <a th:if="${schemaCatalogUrlTemplate.showSchemaCatalogButton()}"
                                                       th:href="@{|${schemaCatalogUrlTemplate.resolveById(record.RegistrySchema.schemaId)}|}"
                                                       th:text="${schemaCatalogUrlTemplate.getName()}"
                                                       target="_blank"
                                                       class="btn btn-success">
                                                        <i th:class="${'fa '+schemaCatalogUrlTemplate.getIcon()+' info'}"></i>
                                                    </a>
                                                    <button th:attr="onclick=${'copySchemaContent('''+recordId+''')'}"
                                                            th:id="${'copy_button_'+recordId}"
                                                            class="btn btn-success">
                                                        Copy
                                                    </button>
                                                    <button type="button"
                                                            class="btn btn-primary"
                                                            data-bs-dismiss="modal">
                                                        Exit
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </td>

                                <td th:if="${record.nullValue and browseParams.isAvroOrProtobufValueFormat()}" class="bg-danger">
                                    <span></span>
                                </td>

                                <td
                                        th:each="column : ${fetchedRecords.listSelectedColumns()}"
                                        th:title="${record.typeSimpleName(column)}"
                                        th:class="${record.nullValue ? 'bg-danger' : ''}" >

                                    <span th:if="${record.nullValue}"></span>
                                    <span th:if="${!record.nullValue}"
                                          th:utext="${record.getShort(column)}">
                                    </span>
                                    <a class="btn btn-sm info"
                                       type="button"
                                       th:if="${record.isTruncated(column)}"
                                       th:data-param-header="${column.name}"
                                       th:data-param-text="${record.getContentPrettyJson(column)}"
                                       th:onclick="showData(this.getAttribute('data-param-header'),
                                                            this.getAttribute('data-param-text') )">
                                        <i class="fa fa-eye info"></i>
                                    </a>
                                </td>
                                <input type="hidden" th:id="${'headers-for_'+recordId}" th:value="${record.headersJson}" />
                            </tr>
                            </tbody>
                        </table>

                    </div>

                </div>

            </div>

        </div>

    </div>

</div>

<div th:replace="templates :: footer"></div>

</body>
</html>
